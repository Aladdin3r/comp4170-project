<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Expense Tracker</title>
		<link rel="stylesheet" href="/styles/main.css" />
		<script>
			async function fetchTransactions(type) {
				let url = "/transactions/" + type;

				// Handle Custom Month Selection
				if (type === "custom") {
					let selectedMonth = document.getElementById("customMonth").value;
					if (!selectedMonth) return; // Do nothing if no month selected

					let [year, month] = selectedMonth.split("-");
					url += `?year=${year}&month=${month}`;
				}

				try {
					let response = await fetch(url);
					let data = await response.json();

					// Update transaction list
					let transactionsList = document.getElementById("transactionsList");
					transactionsList.innerHTML = ""; // Clear previous transactions

					if (data.length === 0) {
						transactionsList.innerHTML = "<li>No transactions found.</li>"; // Show message if empty
						return;
					}

					data.forEach((tx) => {
						let li = document.createElement("li");
						li.style.color = tx.category === "Income" ? "green" : "red"; // âœ… Correct check
						li.innerHTML = `${tx.date} - ${tx.category}: 
                            <strong>${
															tx.category === "Income" ? "+" : ""
														}$${Math.abs(tx.amount)}</strong>`;
						transactionsList.appendChild(li);
					});
				} catch (error) {
					console.error("Error fetching transactions:", error);
				}
			}

			async function fetchBudgetComparison() {
			try {
				let response = await fetch("/budget/comparison");
				let data = await response.json();
				console.log("Received Budget Data:", data); 

				document.getElementById("totalIncome").textContent = `$${data.totalIncome ?? 0}`;
				document.getElementById("totalExpenses").textContent = `$${data.totalExpense ?? 0}`;
				document.getElementById("balance").textContent = `$${data.balance ?? 0}`;

				let message = data.balance >= 0 
					? "ðŸŽ‰ Good Job! You're managing your budget well!"
					: "ðŸ˜ˆ You are naughty! Your expenses are too high!";
				document.getElementById("budgetMessage").textContent = message;
				} catch (error) {
					console.error("Error fetching budget comparison:", error);
				}
			}

			document.addEventListener("DOMContentLoaded", fetchBudgetComparison);
		</script>
	</head>
	<body>
		<div class="container">
			<h1>Add a New Expense</h1>

			<div class="expenseform">
				<form action="/add" method="POST">
					<div class="form-control">
						<label>Amount</label>
						<input type="text" id="amount" name="amount" required />
					</div>

					<div class="form-control">
						<label>Category</label>
						<select name="category_id" required>
							<option value="">Select a category</option>
							<% categories.forEach(category => { %>
							<option value="<%= category.id %>"><%= category.name %></option>
							<% }); %>
						</select>
					</div>

					<div class="form-control">
						<label>Date</label>
						<input type="date" name="date" required />
					</div>

					<button type="submit">Submit Expenses</button>
				</form>
			</div>
			<div class="table">
				<table>
					<thead>
						<tr>
							<th>Amount</th>
							<th>Category</th>
							<th>Date</th>
						</tr>
					</thead>
					<tbody>
						<% expenses.forEach(expense => { %>
						<tr>
							<td>
								<span
									style="color: <%= expense.amount >= 0 ? 'green' : 'red' %>;"
								>
									<%= expense.amount >= 0 ? '+' : '' %>$<%=
									Math.abs(expense.amount) %>
								</span>
							</td>

							<td><%= expense.category %></td>
							<td><%= expense.date %></td>
						</tr>
						<% }); %>
					</tbody>
				</table>
			</div>
		</div>
		<div>
			<div class="r-transactions" class="button-container">
				<button class="recent-button" onclick="fetchTransactions('recent')">
					Recent Transactions
				</button>
				<button class="month-button" onclick="fetchTransactions('month')">This Month</button>
				<input
					type="month"
					id="customMonth"
					onchange="fetchTransactions('custom')"
				/>
			</div>

			<ul class="transactionsList" id="transactionsList">
				<% expenses.forEach(expense => { %>
				<li>
					<%= expense.date %> - <%= expense.category %>:
					<strong
						style="color: <%= expense.category === 'Income' ? 'green' : 'red' %>;"
					>
						<%= expense.category === 'Income' ? '+' : '' %>$<%=
						Math.abs(expense.amount) %>
					</strong>
				</li>
				<% }) %>
			</ul>
		</div>

		<div class="budget-container">
			<h2>TOTAL SUMMARY</h2>
			<p><strong>Total Income:</strong> <span id="totalIncome">$0</span></p>
			<p><strong>Total Expenses:</strong> <span id="totalExpenses">$0</span></p>
			<p><strong>Balance:</strong> <span id="balance">$0</span></p>
			<p id="budgetMessage"></p>
		</div>
		
	</body>
</html>
